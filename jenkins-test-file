pipeline {
    agent {
        docker {
            image 'golang:1.21-alpine'
            args '-v /var/run/docker.sock:/var/run/docker.sock'
        }
    }
    
    environment {
        // ä½¿ç”¨ä½ è‡ªå·±çš„ Docker Hub ç”¨æˆ·å
        DOCKER_IMAGE = 'sunstarfish/my-go-app'
        
        // å¯é€‰ï¼šæ ¹æ®åˆ†æ”¯è®¾ç½®é•œåƒæ ‡ç­¾
        IMAGE_TAG = sh(
            script: 'echo "${BRANCH_NAME:-master}" | sed "s/[^a-zA-Z0-9_.-]/-/g"',
            returnStdout: true
        ).trim() + "-${BUILD_NUMBER}"
    }
    
    stages {
        stage('ä»£ç æ£€å‡º') {
            steps {
                checkout scm
                sh 'git log --oneline -3'  // æŸ¥çœ‹æœ€è¿‘æäº¤
            }
        }
        
        stage('Go ä¾èµ–ç®¡ç†') {
            steps {
                sh '''
                    echo "åˆå§‹åŒ– Go æ¨¡å—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰..."
                    [ -f go.mod ] || go mod init my-go-app
                    
                    echo "æ•´ç†ä¾èµ–..."
                    go mod tidy
                    
                    echo "ä¸‹è½½ä¾èµ–..."
                    go mod download
                '''
            }
        }
        
        stage('æ„å»ºé¡¹ç›®') {
            steps {
                sh '''
                    echo "ç¼–è¯‘é¡¹ç›®..."
                    # å°è¯•ä¸åŒçš„æ„å»ºæ–¹å¼
                    if [ -f "cmd/main.go" ]; then
                        go build -o my-app ./cmd
                    elif [ -f "main.go" ]; then
                        go build -o my-app .
                    else
                        # å°è¯•åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾ main åŒ…
                        go build -o my-app ./...
                    fi
                    
                    echo "æ£€æŸ¥ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶..."
                    ls -lh my-app 2>/dev/null || echo "æœªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶"
                '''
            }
        }
        
        stage('è¿è¡Œæµ‹è¯•') {
            steps {
                sh '''
                    echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
                    go test -v ./... || echo "æµ‹è¯•å¯èƒ½å¤±è´¥"
                    
                    echo "è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰..."
                    go test -bench=. ./... 2>/dev/null || echo "æ²¡æœ‰åŸºå‡†æµ‹è¯•"
                '''
            }
        }
        
        stage('åˆ›å»º Dockerfileï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰') {
            steps {
                sh '''
                    if [ ! -f Dockerfile ]; then
                        echo "åˆ›å»º Dockerfile..."
                        cat > Dockerfile << 'EOF'
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY my-app .
EXPOSE 8080
CMD ["./my-app"]
EOF
                        echo "Dockerfile åˆ›å»ºå®Œæˆ"
                    else
                        echo "å·²å­˜åœ¨ Dockerfile:"
                        cat Dockerfile
                    fi
                '''
            }
        }
        
        stage('æ„å»º Docker é•œåƒ') {
            steps {
                script {
                    echo "å¼€å§‹æ„å»º Docker é•œåƒ..."
                    echo "é•œåƒåç§°: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    
                    // ç¡®ä¿å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨
                    sh 'ls -la my-app || echo "æ­£åœ¨æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶..."'
                    
                    // æ„å»ºé•œåƒ
                    docker.build("${DOCKER_IMAGE}:${IMAGE_TAG}")
                    
                    echo "é•œåƒæ„å»ºå®Œæˆ"
                    sh 'docker images | grep "${DOCKER_IMAGE}"'
                }
            }
        }
        
        stage('æ¨é€ Docker é•œåƒ') {
            when {
                expression { 
                    // åªæœ‰åœ¨ master/main åˆ†æ”¯æ‰æ¨é€
                    return env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'main'
                }
            }
            steps {
                script {
                    echo "å‡†å¤‡æ¨é€é•œåƒåˆ° Docker Hub..."
                    
                    // ç¡®ä¿ Jenkins ä¸­æœ‰ 'dockerhub' å‡­æ®
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub') {
                        // æ¨é€å¸¦æ„å»ºå·çš„ç‰ˆæœ¬
                        docker.image("${DOCKER_IMAGE}:${IMAGE_TAG}").push()
                        
                        // å¦‚æœæ˜¯ç”Ÿäº§éƒ¨ç½²ï¼Œå¯ä»¥æ¨é€åˆ° latest
                        if (env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'main') {
                            docker.image("${DOCKER_IMAGE}:${IMAGE_TAG}").push('latest')
                        }
                    }
                    
                    echo "é•œåƒæ¨é€å®Œæˆ"
                }
            }
        }
        
        stage('æœ¬åœ°éƒ¨ç½²æµ‹è¯•') {
            steps {
                script {
                    echo "åœ¨æœ¬åœ°è¿è¡Œå®¹å™¨æµ‹è¯•..."
                    
                    sh '''
                        # åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨
                        docker stop my-go-app-test 2>/dev/null || true
                        docker rm my-go-app-test 2>/dev/null || true
                        
                        # è¿è¡Œæ–°å®¹å™¨
                        docker run -d \
                            --name my-go-app-test \
                            -p 8080:8080 \
                            ${DOCKER_IMAGE}:${IMAGE_TAG} || echo "å®¹å™¨å¯åŠ¨å¤±è´¥"
                        
                        # ç­‰å¾…å¹¶æ£€æŸ¥å®¹å™¨çŠ¶æ€
                        sleep 5
                        docker ps | grep my-go-app-test
                        
                        # æµ‹è¯•æœåŠ¡ï¼ˆå¦‚æœåº”ç”¨åœ¨ 8080 ç«¯å£æä¾›æœåŠ¡ï¼‰
                        curl -f http://localhost:8080/ || echo "æœåŠ¡å¯èƒ½æœªå¯åŠ¨"
                        
                        # æŸ¥çœ‹å®¹å™¨æ—¥å¿—
                        echo "å®¹å™¨æ—¥å¿—ï¼š"
                        docker logs my-go-app-test --tail 20
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo "ğŸ‰ æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
            echo "é•œåƒåœ°å€: ${DOCKER_IMAGE}:${IMAGE_TAG}"
            
            script {
                // å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
                emailext(
                    subject: "âœ… Go åº”ç”¨æ„å»ºæˆåŠŸ: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: """
                    é¡¹ç›®: ${env.JOB_NAME}
                    æ„å»º: #${env.BUILD_NUMBER}
                    çŠ¶æ€: âœ… æˆåŠŸ
                    é•œåƒ: ${DOCKER_IMAGE}:${IMAGE_TAG}
                    åˆ†æ”¯: ${env.BRANCH_NAME}
                    æäº¤: ${env.GIT_COMMIT}
                    """,
                    to: 'your-email@example.com'
                )
            }
        }
        failure {
            echo "âŒ æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼"
            
            script {
                // å¤±è´¥æ—¶å‘é€é€šçŸ¥
                emailext(
                    subject: "âŒ Go åº”ç”¨æ„å»ºå¤±è´¥: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: """
                    é¡¹ç›®: ${env.JOB_NAME}
                    æ„å»º: #${env.BUILD_NUMBER}
                    çŠ¶æ€: âŒ å¤±è´¥
                    åˆ†æ”¯: ${env.BRANCH_NAME}
                    è¯·æŸ¥çœ‹ Jenkins æ§åˆ¶å°è¾“å‡ºè·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
                    """,
                    to: 'your-email@example.com'
                )
            }
        }
        always {
            echo "æ¸…ç†å·¥ä½œ..."
            sh '''
                # æ¸…ç†æµ‹è¯•å®¹å™¨
                docker stop my-go-app-test 2>/dev/null || true
                docker rm my-go-app-test 2>/dev/null || true
                
                # æ¸…ç† Docker ç¼“å­˜
                docker system prune -f 2>/dev/null || true
            '''
            
            cleanWs()  // æ¸…ç†å·¥ä½œç©ºé—´
        }
    }
}